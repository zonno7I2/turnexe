<!DOCTYPE html>
<html lang="ja" dir="ltr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Copilot - 管理者ダッシュボード</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      line-height: 1.6;
    }
    
    /* ===== 管理者ログイン画面 ===== */
    .admin-login {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      padding: 20px;
    }
    
    .admin-login-container {
      width: 100%;
      max-width: 400px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    
    .admin-login-header {
      padding: 24px;
      text-align: center;
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
    }
    
    .admin-login-header h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .admin-login-header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .admin-login-body {
      padding: 32px;
    }
    
    .admin-login-form .form-group {
      margin-bottom: 20px;
    }
    
    .admin-login-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #cbd5e1;
    }
    
    .admin-login-form input {
      width: 100%;
      padding: 12px 16px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    .admin-login-form input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .admin-login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .admin-login-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2);
    }
    
    /* ===== 管理者ダッシュボード ===== */
    .admin-dashboard {
      display: none;
      min-height: 100vh;
    }
    
    .admin-sidebar {
      width: 260px;
      background: #020617;
      border-right: 1px solid #334155;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      padding: 24px 0;
      overflow-y: auto;
    }
    
    .admin-brand {
      padding: 0 24px 24px;
      border-bottom: 1px solid #334155;
      margin-bottom: 24px;
    }
    
    .admin-brand h2 {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }
    
    .admin-brand p {
      font-size: 12px;
      color: #94a3b8;
    }
    
    .admin-nav {
      padding: 0 16px;
    }
    
    .admin-nav-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      color: #cbd5e1;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .admin-nav-item:hover {
      background: #1e293b;
      color: white;
    }
    
    .admin-nav-item.active {
      background: #1e293b;
      color: white;
      font-weight: 500;
    }
    
    .admin-nav-item i {
      margin-right: 12px;
      font-size: 18px;
    }
    
    .admin-logout-btn {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      color: #f87171;
      background: none;
      border: none;
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }
    
    .admin-logout-btn:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    .admin-main {
      margin-left: 260px;
      padding: 24px;
      background: #0f172a;
      min-height: 100vh;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid #334155;
    }
    
    .admin-header h1 {
      font-size: 28px;
      font-weight: 700;
    }
    
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 24px;
      transition: all 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 16px;
    }
    
    .stat-icon.users {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }
    
    .stat-icon.domains {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }
    
    .stat-icon.history {
      background: rgba(168, 85, 247, 0.1);
      color: #a855f7;
    }
    
    .stat-icon.system {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .stat-card .change {
      font-size: 12px;
      color: #22c55e;
    }
    
    .admin-section {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      margin-bottom: 32px;
      overflow: hidden;
    }
    
    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .section-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .section-header .actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #334155;
      background: #0f172a;
      color: #cbd5e1;
    }
    
    .btn-primary {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-danger {
      background: #ef4444;
      border-color: #ef4444;
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-success {
      background: #22c55e;
      border-color: #22c55e;
      color: white;
    }
    
    .btn-success:hover {
      background: #16a34a;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #0f172a;
    }
    
    th {
      padding: 16px 24px;
      text-align: left;
      font-size: 14px;
      font-weight: 500;
      color: #94a3b8;
      border-bottom: 1px solid #334155;
    }
    
    td {
      padding: 16px 24px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background: rgba(30, 41, 59, 0.5);
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    
    .badge {
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }
    
    .badge-warning {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }
    
    .badge-info {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }
    
    .badge-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
    
    .domain-list {
      padding: 0;
    }
    
    .domain-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid #334155;
    }
    
    .domain-item:last-child {
      border-bottom: none;
    }
    
    .domain-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .domain-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(59, 130, 246, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #3b82f6;
      font-size: 18px;
    }
    
    .system-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 24px;
    }
    
    .status-item {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 20px;
    }
    
    .status-item h3 {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    
    .status-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .status-desc {
      font-size: 12px;
      color: #94a3b8;
    }
    
    .status-good {
      color: #22c55e;
    }
    
    .status-warning {
      color: #f59e0b;
    }
    
    .status-error {
      color: #ef4444;
    }
    
    /* モーダル */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal-content {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      overflow: hidden;
    }
    
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      font-size: 20px;
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #334155;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #cbd5e1;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      min-height: 120px;
      resize: vertical;
    }
    
    .search-box {
      width: 100%;
      max-width: 400px;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }
    
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #94a3b8;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    /* 通知 */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      max-width: 400px;
      transform: translateX(120%);
      transition: transform 0.3s;
      z-index: 9999;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .notification.success .notification-icon {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }
    
    .notification.error .notification-icon {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .notification-close {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
    }
    
    /* ローディング */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #334155;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* レスポンシブ */
    @media (max-width: 1024px) {
      .admin-sidebar {
        width: 80px;
      }
      
      .admin-sidebar .admin-nav-item span,
      .admin-sidebar .admin-brand h2,
      .admin-sidebar .admin-brand p,
      .admin-sidebar .admin-logout-btn span {
        display: none;
      }
      
      .admin-main {
        margin-left: 80px;
      }
      
      .admin-nav-item {
        justify-content: center;
      }
      
      .admin-nav-item i {
        margin-right: 0;
        font-size: 20px;
      }
    }
    
    @media (max-width: 768px) {
      .admin-sidebar {
        width: 100%;
        height: auto;
        position: relative;
        padding: 16px;
      }
      
      .admin-main {
        margin-left: 0;
      }
      
      .admin-nav {
        display: flex;
        overflow-x: auto;
        padding-bottom: 8px;
      }
      
      .admin-nav-item {
        white-space: nowrap;
      }
    }
  </style>
  
  <!-- アイコンフォント -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- 管理者ログイン画面 -->
  <div id="adminLogin" class="admin-login">
    <div class="admin-login-container">
      <div class="admin-login-header">
        <h1>Copilot 管理コンソール</h1>
        <p>システム管理者専用ログイン</p>
      </div>
      <div class="admin-login-body">
        <form class="admin-login-form" id="adminLoginForm">
          <div class="form-group">
            <label for="adminUsername">管理者ID</label>
            <input type="text" id="adminUsername" placeholder="admin" required>
          </div>
          <div class="form-group">
            <label for="adminPassword">パスワード</label>
            <input type="password" id="adminPassword" placeholder="••••••••" required>
          </div>
          <button type="submit" class="admin-login-btn">ログイン</button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- 管理者ダッシュボード -->
  <div id="adminDashboard" class="admin-dashboard">
    <!-- サイドバー -->
    <div class="admin-sidebar">
      <div class="admin-brand">
        <h2>Copilot Admin</h2>
        <p>管理者ダッシュボード</p>
      </div>
      
      <nav class="admin-nav">
        <a href="#" class="admin-nav-item active" data-section="dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span>ダッシュボード</span>
        </a>
        <a href="#" class="admin-nav-item" data-section="users">
          <i class="fas fa-users"></i>
          <span>ユーザー管理</span>
        </a>
        <a href="#" class="admin-nav-item" data-section="domains">
          <i class="fas fa-globe"></i>
          <span>ドメイン管理</span>
        </a>
        <a href="#" class="admin-nav-item" data-section="history">
          <i class="fas fa-history"></i>
          <span>チャット履歴</span>
        </a>
        <a href="#" class="admin-nav-item" data-section="system">
          <i class="fas fa-cog"></i>
          <span>システム設定</span>
        </a>
        <a href="#" class="admin-nav-item" data-section="api">
          <i class="fas fa-code"></i>
          <span>API管理</span>
        </a>
        <a href="#" class="admin-nav-item" data-section="logs">
          <i class="fas fa-clipboard-list"></i>
          <span>アクセスログ</span>
        </a>
      </nav>
      
      <button class="admin-logout-btn" id="adminLogoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>ログアウト</span>
      </button>
    </div>
    
    <!-- メインコンテンツ -->
    <div class="admin-main">
      <div class="admin-header">
        <h1 id="adminPageTitle">ダッシュボード</h1>
        <div class="admin-user-info">
          <span id="adminCurrentUser">管理者</span>
          <span class="badge badge-success">管理者</span>
        </div>
      </div>
      
      <!-- ダッシュボードセクション -->
      <div id="sectionDashboard" class="admin-section active">
        <div class="section-header">
          <h2>システム概要</h2>
          <div class="actions">
            <button class="btn" onclick="refreshStats()">
              <i class="fas fa-sync-alt"></i> 更新
            </button>
          </div>
        </div>
        
        <div class="admin-stats">
          <div class="stat-card">
            <div class="stat-icon users">
              <i class="fas fa-users"></i>
            </div>
            <h3>総ユーザー数</h3>
            <div class="value" id="statTotalUsers">0</div>
            <div class="change" id="statUserChange">+0 今日</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon domains">
              <i class="fas fa-globe"></i>
            </div>
            <h3>許可ドメイン</h3>
            <div class="value" id="statTotalDomains">0</div>
            <div class="change" id="statDomainChange">+0 今月</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon history">
              <i class="fas fa-history"></i>
            </div>
            <h3>チャット履歴</h3>
            <div class="value" id="statTotalMessages">0</div>
            <div class="change" id="statMessageChange">+0 今日</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon system">
              <i class="fas fa-server"></i>
            </div>
            <h3>API使用状況</h3>
            <div class="value" id="statApiStatus">正常</div>
            <div class="change" id="statApiUsage">0% 負荷</div>
          </div>
        </div>
        
        <div class="system-status">
          <div class="status-item">
            <h3>サーバー状態</h3>
            <div class="status-value status-good" id="serverStatus">正常</div>
            <div class="status-desc">稼働時間: <span id="serverUptime">0日 00:00:00</span></div>
          </div>
          
          <div class="status-item">
            <h3>データベース</h3>
            <div class="status-value status-good" id="databaseStatus">正常</div>
            <div class="status-desc">サイズ: <span id="databaseSize">0 KB</span></div>
          </div>
          
          <div class="status-item">
            <h3>API接続</h3>
            <div class="status-value status-good" id="apiConnectionStatus">接続済み</div>
            <div class="status-desc">モデル: <span id="apiModel">Gemini 2.5 Flash Lite</span></div>
          </div>
        </div>
      </div>
      
      <!-- ユーザー管理セクション -->
      <div id="sectionUsers" class="admin-section" style="display: none;">
        <div class="section-header">
          <h2>ユーザー管理</h2>
          <div class="actions">
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" id="userSearch" placeholder="ユーザー名、メールアドレスで検索...">
            </div>
            <button class="btn btn-primary" onclick="showAddUserModal()">
              <i class="fas fa-user-plus"></i> ユーザー追加
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table id="usersTable">
            <thead>
              <tr>
                <th>ユーザー</th>
                <th>メールアドレス</th>
                <th>登録日</th>
                <th>最終ログイン</th>
                <th>認証方法</th>
                <th>状態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- ユーザーデータが動的に挿入されます -->
            </tbody>
          </table>
        </div>
        
        <div class="empty-state" id="usersEmptyState" style="display: none;">
          <div class="empty-state-icon">
            <i class="fas fa-users"></i>
          </div>
          <h3>ユーザーが見つかりません</h3>
          <p>ユーザーを追加するか、検索条件を変更してください。</p>
        </div>
      </div>
      
      <!-- ドメイン管理セクション -->
      <div id="sectionDomains" class="admin-section" style="display: none;">
        <div class="section-header">
          <h2>ドメイン管理</h2>
          <div class="actions">
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" id="domainSearch" placeholder="ドメイン名で検索...">
            </div>
            <button class="btn btn-primary" onclick="showAddDomainModal()">
              <i class="fas fa-plus"></i> ドメイン追加
            </button>
          </div>
        </div>
        
        <div class="domain-list" id="domainList">
          <!-- ドメインリストが動的に挿入されます -->
        </div>
        
        <div class="empty-state" id="domainsEmptyState" style="display: none;">
          <div class="empty-state-icon">
            <i class="fas fa-globe"></i>
          </div>
          <h3>ドメインが見つかりません</h3>
          <p>ドメインを追加してください。</p>
        </div>
      </div>
      
      <!-- チャット履歴セクション -->
      <div id="sectionHistory" class="admin-section" style="display: none;">
        <div class="section-header">
          <h2>チャット履歴</h2>
          <div class="actions">
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" id="historySearch" placeholder="ユーザー名、メッセージで検索...">
            </div>
            <button class="btn btn-danger" onclick="clearAllHistory()">
              <i class="fas fa-trash"></i> 全履歴削除
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table id="historyTable">
            <thead>
              <tr>
                <th>ユーザー</th>
                <th>日時</th>
                <th>メッセージ内容</th>
                <th>AI応答</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- 履歴データが動的に挿入されます -->
            </tbody>
          </table>
        </div>
        
        <div class="empty-state" id="historyEmptyState" style="display: none;">
          <div class="empty-state-icon">
            <i class="fas fa-history"></i>
          </div>
          <h3>履歴が見つかりません</h3>
          <p>まだチャット履歴がありません。</p>
        </div>
      </div>
      
      <!-- システム設定セクション -->
      <div id="sectionSystem" class="admin-section" style="display: none;">
        <div class="section-header">
          <h2>システム設定</h2>
          <div class="actions">
            <button class="btn btn-success" onclick="saveSystemSettings()">
              <i class="fas fa-save"></i> 設定保存
            </button>
          </div>
        </div>
        
        <div class="modal-body" style="padding: 24px;">
          <div class="form-group">
            <label class="form-label">管理者ユーザー名</label>
            <input type="text" class="form-input" id="systemAdminUsername" value="admin">
            <small style="color: #94a3b8; font-size: 12px;">管理者ログイン用のユーザー名</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">管理者パスワード</label>
            <input type="password" class="form-input" id="systemAdminPassword" placeholder="変更する場合のみ入力">
            <small style="color: #94a3b8; font-size: 12px;">空欄の場合は現在のパスワードを維持</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">セッション有効期限（時間）</label>
            <input type="number" class="form-input" id="systemSessionTimeout" value="24" min="1" max="720">
            <small style="color: #94a3b8; font-size: 12px;">ユーザーセッションの有効期限（1-720時間）</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">最大ユーザー数</label>
            <input type="number" class="form-input" id="systemMaxUsers" value="1000" min="1" max="100000">
            <small style="color: #94a3b8; font-size: 12px;">システムがサポートする最大ユーザー数</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">デフォルトAIモデル</label>
            <select class="form-input" id="systemDefaultModel">
              <option value="gemini-2.5-flash-lite" selected>Gemini 2.5 Flash Lite</option>
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
              <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">メンテナンスモード</label>
            <div style="margin-top: 8px;">
              <input type="checkbox" id="systemMaintenanceMode" style="margin-right: 8px;">
              <label for="systemMaintenanceMode">メンテナンスモードを有効にする</label>
            </div>
            <small style="color: #94a3b8; font-size: 12px;">有効時は一般ユーザーのアクセスを制限します</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">メンテナンスメッセージ</label>
            <textarea class="form-textarea" id="systemMaintenanceMessage" placeholder="メンテナンス中の表示メッセージ"></textarea>
          </div>
        </div>
      </div>
      
      <!-- API管理セクション -->
      <div id="sectionApi" class="admin-section" style="display: none;">
        <div class="section-header">
          <h2>API管理</h2>
          <div class="actions">
            <button class="btn btn-primary" onclick="testApiConnection()">
              <i class="fas fa-plug"></i> API接続テスト
            </button>
          </div>
        </div>
        
        <div class="modal-body" style="padding: 24px;">
          <div class="form-group">
            <label class="form-label">Google APIキー</label>
            <input type="password" class="form-input" id="apiGoogleKey" placeholder="••••••••">
            <small style="color: #94a3b8; font-size: 12px;">現在の設定: <span id="apiKeyStatus">未設定</span></small>
          </div>
          
          <div class="form-group">
            <label class="form-label">Google Client ID</label>
            <input type="text" class="form-input" id="apiClientId" placeholder="クライアントID">
            <small style="color: #94a3b8; font-size: 12px;">OAuth認証用のクライアントID</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">APIレート制限（分あたり）</label>
            <input type="number" class="form-input" id="apiRateLimit" value="60" min="1" max="1000">
            <small style="color: #94a3b8; font-size: 12px;">1ユーザーあたりの1分間の最大リクエスト数</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">API使用統計</label>
            <div style="background: #0f172a; border-radius: 8px; padding: 16px; margin-top: 8px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>今日のリクエスト数:</span>
                <span id="apiRequestsToday">0</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>今月のリクエスト数:</span>
                <span id="apiRequestsMonth">0</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>エラー率:</span>
                <span id="apiErrorRate">0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- アクセスログセクション -->
      <div id="sectionLogs" class="admin-section" style="display: none;">
        <div class="section-header">
          <h2>アクセスログ</h2>
          <div class="actions">
            <button class="btn btn-danger" onclick="clearAccessLogs()">
              <i class="fas fa-trash"></i> ログクリア
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table id="logsTable">
            <thead>
              <tr>
                <th>日時</th>
                <th>IPアドレス</th>
                <th>ユーザー</th>
                <th>アクション</th>
                <th>エンドポイント</th>
                <th>ステータス</th>
              </tr>
            </thead>
            <tbody id="logsTableBody">
              <!-- ログデータが動的に挿入されます -->
            </tbody>
          </table>
        </div>
        
        <div class="empty-state" id="logsEmptyState" style="display: none;">
          <div class="empty-state-icon">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <h3>ログが見つかりません</h3>
          <p>まだアクセスログがありません。</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 通知コンテナ -->
  <div id="notificationContainer"></div>
  
  <!-- ユーザー追加モーダル -->
  <div id="addUserModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ユーザー追加</h2>
        <button class="modal-close" onclick="closeModal('addUserModal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">名前</label>
          <input type="text" class="form-input" id="addUserName" placeholder="山田 太郎">
        </div>
        <div class="form-group">
          <label class="form-label">メールアドレス</label>
          <input type="email" class="form-input" id="addUserEmail" placeholder="user@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">パスワード</label>
          <input type="password" class="form-input" id="addUserPassword" placeholder="••••••••">
        </div>
        <div class="form-group">
          <label class="form-label">権限レベル</label>
          <select class="form-input" id="addUserRole">
            <option value="user" selected>一般ユーザー</option>
            <option value="moderator">モデレーター</option>
            <option value="admin">管理者</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('addUserModal')">キャンセル</button>
        <button class="btn btn-primary" onclick="addNewUser()">追加</button>
      </div>
    </div>
  </div>
  
  <!-- ドメイン追加モーダル -->
  <div id="addDomainModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ドメイン追加</h2>
        <button class="modal-close" onclick="closeModal('addDomainModal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ドメイン名</label>
          <input type="text" class="form-input" id="addDomainName" placeholder="example.com">
          <small style="color: #94a3b8; font-size: 12px;">例: company.com, school.edu, *.ac.jp など</small>
        </div>
        <div class="form-group">
          <label class="form-label">説明</label>
          <input type="text" class="form-input" id="addDomainDescription" placeholder="社内ドメイン">
        </div>
        <div class="form-group">
          <label class="form-label">許可タイプ</label>
          <select class="form-input" id="addDomainType">
            <option value="exact" selected>完全一致（example.com）</option>
            <option value="subdomain">サブドメイン全体（*.example.com）</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('addDomainModal')">キャンセル</button>
        <button class="btn btn-primary" onclick="addNewDomain()">追加</button>
      </div>
    </div>
  </div>
  
  <!-- ユーザー編集モーダル -->
  <div id="editUserModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ユーザー編集</h2>
        <button class="modal-close" onclick="closeModal('editUserModal')">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editUserId">
        <div class="form-group">
          <label class="form-label">名前</label>
          <input type="text" class="form-input" id="editUserName">
        </div>
        <div class="form-group">
          <label class="form-label">メールアドレス</label>
          <input type="email" class="form-input" id="editUserEmail" disabled>
        </div>
        <div class="form-group">
          <label class="form-label">新しいパスワード</label>
          <input type="password" class="form-input" id="editUserPassword" placeholder="変更する場合のみ入力">
        </div>
        <div class="form-group">
          <label class="form-label">権限レベル</label>
          <select class="form-input" id="editUserRole">
            <option value="user">一般ユーザー</option>
            <option value="moderator">モデレーター</option>
            <option value="admin">管理者</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">アカウント状態</label>
          <select class="form-input" id="editUserStatus">
            <option value="active">アクティブ</option>
            <option value="suspended">一時停止</option>
            <option value="banned">禁止</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteUser()">削除</button>
        <button class="btn" onclick="closeModal('editUserModal')">キャンセル</button>
        <button class="btn btn-primary" onclick="saveUserChanges()">保存</button>
      </div>
    </div>
  </div>
  
  <!-- 確認モーダル -->
  <div id="confirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="confirmTitle">確認</h2>
        <button class="modal-close" onclick="closeModal('confirmModal')">✕</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage">この操作を実行しますか？</p>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="confirmAction(false)">キャンセル</button>
        <button class="btn btn-primary" onclick="confirmAction(true)">OK</button>
      </div>
    </div>
  </div>
  
  <script>
  // 管理者インターフェースのメインスクリプト
let currentAdminUser = '';
let confirmCallback = null;
let currentEditingUser = null;

// DOM要素
const adminLogin = document.getElementById('adminLogin');
const adminDashboard = document.getElementById('adminDashboard');
const adminLoginForm = document.getElementById('adminLoginForm');
const adminLogoutBtn = document.getElementById('adminLogoutBtn');
const adminPageTitle = document.getElementById('adminPageTitle');
const adminCurrentUser = document.getElementById('adminCurrentUser');

// 初期化
document.addEventListener('DOMContentLoaded', () => {
    // 管理者ログイン状態を確認
    checkAdminStatus();
    
    // ログインフォーム送信
    adminLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await adminLoginAction();
    });
    
    // ログアウト
    adminLogoutBtn.addEventListener('click', adminLogout);
    
    // ナビゲーション
    document.querySelectorAll('.admin-nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const section = item.getAttribute('data-section');
            switchSection(section);
        });
    });
    
    // 検索ボックスのイベントリスナー
    const userSearch = document.getElementById('userSearch');
    if (userSearch) {
        userSearch.addEventListener('input', debounce(() => {
            loadUsers(userSearch.value);
        }, 300));
    }
    
    const domainSearch = document.getElementById('domainSearch');
    if (domainSearch) {
        domainSearch.addEventListener('input', debounce(() => {
            loadDomains(domainSearch.value);
        }, 300));
    }
});

// 管理者ステータス確認
async function checkAdminStatus() {
    try {
        const response = await fetch('/admin/status', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.logged_in) {
                currentAdminUser = data.username;
                showDashboard();
                loadDashboardData();
            }
        }
    } catch (error) {
        console.error('ステータス確認エラー:', error);
    }
}

// 管理者ログイン
async function adminLoginAction() {
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    
    if (!username || !password) {
        showNotification('エラー', '管理者IDとパスワードを入力してください', 'error');
        return;
    }
    
    try {
        const response = await adminRequest('/admin/login', {
            method: 'POST',
            body: JSON.stringify({ username, password })
        });
        
        if (response && response.ok) {
            const data = await response.json();
            currentAdminUser = data.user;
            showDashboard();
            loadDashboardData();
            showNotification('成功', '管理者としてログインしました', 'success');
        } else if (response) {
            const data = await response.json();
            showNotification('エラー', data.error || '認証に失敗しました', 'error');
        }
    } catch (error) {
        console.error('管理者ログインエラー:', error);
        showNotification('エラー', '管理者認証に失敗しました', 'error');
    }
}

// 管理者APIリクエスト（共通関数）
async function adminRequest(url, options = {}) {
    const defaultOptions = {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        }
    };
    
    const mergedOptions = { ...defaultOptions, ...options };
    
    try {
        const response = await fetch(url, mergedOptions);
        if (response.status === 401) {
            adminLogout();
            showNotification('エラー', 'セッションが切れました。再ログインしてください。', 'error');
            return null;
        }
        return response;
    } catch (error) {
        console.error('APIリクエストエラー:', error);
        showNotification('エラー', 'サーバー接続エラー', 'error');
        return null;
    }
}

// ダッシュボード表示
function showDashboard() {
    adminLogin.style.display = 'none';
    adminDashboard.style.display = 'block';
    adminCurrentUser.textContent = currentAdminUser;
}

// ダッシュボードデータ読み込み
async function loadDashboardData() {
    try {
        const response = await adminRequest('/admin/stats');
        if (response && response.ok) {
            const data = await response.json();
            updateDashboardStats(data.data || data);
        } else {
            console.error('統計データの取得に失敗');
        }
    } catch (error) {
        console.error('データ読み込みエラー:', error);
    }
}

// ダッシュボード統計更新
function updateDashboardStats(stats) {
    document.getElementById('statTotalUsers').textContent = stats.total_users || 0;
    document.getElementById('statUserChange').textContent = `+${stats.new_users_today || 0} 今日`;
    document.getElementById('statTotalDomains').textContent = stats.total_domains || 0;
    document.getElementById('statDomainChange').textContent = '+0 今月';
    document.getElementById('statTotalMessages').textContent = stats.total_messages || 0;
    document.getElementById('statMessageChange').textContent = `+${stats.new_messages_today || 0} 今日`;
    document.getElementById('statApiStatus').textContent = stats.api_status || '正常';
    document.getElementById('statApiUsage').textContent = `${stats.api_usage || 0} リクエスト`;
    
    document.getElementById('serverStatus').textContent = stats.server_status || '正常';
    document.getElementById('serverUptime').textContent = stats.server_uptime || '0日 00:00:00';
    document.getElementById('databaseStatus').textContent = stats.database_status || '正常';
    document.getElementById('databaseSize').textContent = stats.database_size || '0 KB';
    document.getElementById('apiConnectionStatus').textContent = stats.api_connection || '接続済み';
    document.getElementById('apiModel').textContent = stats.api_model || 'Gemini 2.5 Flash Lite';
}

// ユーザー一覧を読み込み
async function loadUsers(searchQuery = '') {
    try {
        let url = '/admin/users';
        if (searchQuery) {
            url += `?search=${encodeURIComponent(searchQuery)}`;
        }
        
        const response = await adminRequest(url);
        if (response && response.ok) {
            const data = await response.json();
            renderUsersTable(data.data || data);
        }
    } catch (error) {
        console.error('ユーザーデータ読み込みエラー:', error);
    }
}

// ユーザーテーブル描画
function renderUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    const emptyState = document.getElementById('usersEmptyState');
    
    if (!users || users.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="user-avatar">${user.name?.charAt(0) || 'U'}</div>
                    <div>
                        <div style="font-weight: 500;">${user.name || user.email}</div>
                        <div style="font-size: 12px; color: #94a3b8;">${user.role || 'user'}</div>
                    </div>
                </div>
            </td>
            <td>${user.email}</td>
            <td>${formatDate(user.created_at)}</td>
            <td>${user.last_login ? formatDate(user.last_login) : '未ログイン'}</td>
            <td>${user.provider === 'google' ? 'Google' : 'メール/パスワード'}</td>
            <td>
                <span class="badge ${getStatusBadgeClass(user.status)}">
                    ${getStatusText(user.status)}
                </span>
            </td>
            <td>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="editUser('${user.email}')" style="padding: 4px 8px; font-size: 12px;">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteUserConfirm('${user.email}', '${user.name}')" style="padding: 4px 8px; font-size: 12px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// ユーザー編集
function editUser(email) {
    currentEditingUser = email;
    
    // ユーザー情報を取得して編集モーダルを表示
    loadUserDetails(email).then(user => {
        if (user) {
            document.getElementById('editUserId').value = user.email;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserRole').value = user.role || 'user';
            document.getElementById('editUserStatus').value = user.status || 'active';
            document.getElementById('editUserPassword').value = '';
            
            document.getElementById('editUserModal').style.display = 'flex';
        }
    });
}

// ユーザー詳細を取得
async function loadUserDetails(email) {
    try {
        const response = await adminRequest('/admin/users?search=' + encodeURIComponent(email));
        if (response && response.ok) {
            const data = await response.json();
            const users = data.data || data;
            return users.find(u => u.email === email);
        }
        return null;
    } catch (error) {
        console.error('ユーザー詳細取得エラー:', error);
        return null;
    }
}

// ユーザー保存
async function saveUserChanges() {
    const email = document.getElementById('editUserEmail').value;
    const name = document.getElementById('editUserName').value;
    const password = document.getElementById('editUserPassword').value;
    const role = document.getElementById('editUserRole').value;
    const status = document.getElementById('editUserStatus').value;
    
    const updateData = {
        email: email,
        name: name,
        role: role,
        status: status
    };
    
    if (password) {
        updateData.password = password;
    }
    
    try {
        const response = await adminRequest('/admin/users/update', {
            method: 'POST',
            body: JSON.stringify(updateData)
        });
        
        if (response && response.ok) {
            showNotification('成功', 'ユーザー情報を更新しました', 'success');
            closeModal('editUserModal');
            loadUsers();
        } else if (response) {
            const data = await response.json();
            showNotification('エラー', data.error || '更新に失敗しました', 'error');
        }
    } catch (error) {
        showNotification('エラー', 'ユーザー更新中にエラーが発生しました', 'error');
    }
}

// ユーザー削除確認
function deleteUserConfirm(email, name) {
    showConfirm(
        'ユーザー削除',
        `ユーザー「${name || email}」を削除しますか？この操作は元に戻せません。`,
        async (confirmed) => {
            if (confirmed) {
                await deleteUser(email);
            }
        }
    );
}

// ユーザー削除
async function deleteUser(email) {
    try {
        const response = await adminRequest('/admin/users/delete', {
            method: 'POST',
            body: JSON.stringify({ email: email })
        });
        
        if (response && response.ok) {
            showNotification('成功', 'ユーザーを削除しました', 'success');
            loadUsers();
        } else if (response) {
            const data = await response.json();
            showNotification('エラー', data.error || '削除に失敗しました', 'error');
        }
    } catch (error) {
        showNotification('エラー', 'ユーザー削除中にエラーが発生しました', 'error');
    }
}

// ドメイン一覧を読み込み
async function loadDomains(searchQuery = '') {
    try {
        const response = await adminRequest('/admin/domains');
        if (response && response.ok) {
            const data = await response.json();
            let domains = data.data || data;
            
            // クライアント側で検索
            if (searchQuery) {
                domains = domains.filter(domain => 
                    domain.domain.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    domain.description.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }
            
            renderDomainList(domains);
        }
    } catch (error) {
        console.error('ドメインデータ読み込みエラー:', error);
    }
}

// ドメインリスト描画
function renderDomainList(domains) {
    const container = document.getElementById('domainList');
    const emptyState = document.getElementById('domainsEmptyState');
    
    if (!domains || domains.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    container.innerHTML = domains.map(domain => `
        <div class="domain-item">
            <div class="domain-info">
                <div class="domain-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <div>
                    <div style="font-weight: 500;">${domain.domain}</div>
                    <div style="font-size: 12px; color: #94a3b8;">${domain.description || '説明なし'}</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 2px;">
                        ${domain.type === 'exact' ? '完全一致' : 'サブドメイン全体'} 
                        • ${formatDate(domain.created_at)}
                        • ${domain.created_by || '不明'}
                    </div>
                </div>
            </div>
            <button class="btn btn-danger" onclick="deleteDomainConfirm('${domain.domain}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

// ドメイン削除確認
function deleteDomainConfirm(domain) {
    showConfirm(
        'ドメイン削除',
        `ドメイン「${domain}」を削除しますか？この操作は元に戻せません。`,
        async (confirmed) => {
            if (confirmed) {
                await deleteDomain(domain);
            }
        }
    );
}

// ドメイン削除
async function deleteDomain(domain) {
    try {
        const response = await adminRequest('/admin/domains/delete', {
            method: 'POST',
            body: JSON.stringify({ domain: domain })
        });
        
        if (response && response.ok) {
            showNotification('成功', 'ドメインを削除しました', 'success');
            loadDomains();
        } else if (response) {
            const data = await response.json();
            showNotification('エラー', data.error || '削除に失敗しました', 'error');
        }
    } catch (error) {
        showNotification('エラー', 'ドメイン削除中にエラーが発生しました', 'error');
    }
}

// 履歴を読み込み
async function loadHistory(searchQuery = '') {
    try {
        const response = await adminRequest('/admin/history');
        if (response && response.ok) {
            const data = await response.json();
            let history = data.data || data;
            
            // クライアント側で検索
            if (searchQuery) {
                history = history.filter(record => 
                    record.user_email.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    record.user_name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    record.message.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    record.ai_response.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }
            
            renderHistoryTable(history);
        }
    } catch (error) {
        console.error('履歴データ読み込みエラー:', error);
    }
}

// 履歴テーブル描画
function renderHistoryTable(history) {
    const tbody = document.getElementById('historyTableBody');
    const emptyState = document.getElementById('historyEmptyState');
    
    if (!history || history.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    tbody.innerHTML = history.slice(0, 50).map(record => `
        <tr>
            <td>
                <div style="font-weight: 500;">${record.user_name || record.user_email}</div>
                <div style="font-size: 12px; color: #94a3b8;">${record.user_email}</div>
            </td>
            <td>${formatDateTime(record.timestamp)}</td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                ${record.message.substring(0, 50)}${record.message.length > 50 ? '...' : ''}
            </td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                ${record.ai_response ? record.ai_response.substring(0, 50) + (record.ai_response.length > 50 ? '...' : '') : 'AI応答なし'}
            </td>
            <td>
                <button class="btn btn-danger" onclick="deleteHistoryConfirm('${record.user_email}', '${record.timestamp}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// 全履歴削除
async function clearAllHistory() {
    showConfirm(
        '全履歴削除',
        'すべてのチャット履歴を削除しますか？この操作は元に戻せません。',
        async (confirmed) => {
            if (confirmed) {
                try {
                    const response = await adminRequest('/admin/history/clear', {
                        method: 'POST'
                    });
                    
                    if (response && response.ok) {
                        showNotification('成功', 'すべての履歴を削除しました', 'success');
                        loadHistory();
                    } else {
                        showNotification('エラー', '履歴削除に失敗しました', 'error');
                    }
                } catch (error) {
                    showNotification('エラー', '履歴削除中にエラーが発生しました', 'error');
                }
            }
        }
    );
}

// 履歴削除確認
function deleteHistoryConfirm(email, timestamp) {
    showConfirm(
        '履歴削除',
        'この履歴エントリを削除しますか？',
        async (confirmed) => {
            if (confirmed) {
                showNotification('情報', '個別履歴削除機能は実装中です', 'info');
            }
        }
    );
}

// ログを読み込み
async function loadLogs() {
    try {
        const response = await adminRequest('/admin/logs');
        if (response && response.ok) {
            const data = await response.json();
            renderLogsTable(data.data || data);
        }
    } catch (error) {
        console.error('ログデータ読み込みエラー:', error);
    }
}

// ログテーブル描画
function renderLogsTable(logs) {
    const tbody = document.getElementById('logsTableBody');
    const emptyState = document.getElementById('logsEmptyState');
    
    if (!logs || logs.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    tbody.innerHTML = logs.map(log => `
        <tr>
            <td>${formatDateTime(log.timestamp)}</td>
            <td>${log.ip_address || '不明'}</td>
            <td>${log.user || '未認証'}</td>
            <td>${log.action || '不明'}</td>
            <td>${log.endpoint || '不明'}</td>
            <td>
                <span class="badge ${log.status >= 400 ? 'badge-danger' : 'badge-success'}">
                    ${log.status || 200}
                </span>
            </td>
        </tr>
    `).join('');
}

// ログクリア
async function clearAccessLogs() {
    showConfirm(
        'ログクリア',
        'すべてのアクセスログをクリアしますか？この操作は元に戻せません。',
        async (confirmed) => {
            if (confirmed) {
                try {
                    const response = await adminRequest('/admin/logs/clear', {
                        method: 'POST'
                    });
                    
                    if (response && response.ok) {
                        showNotification('成功', 'ログをクリアしました', 'success');
                        loadLogs();
                    } else {
                        showNotification('エラー', 'ログクリアに失敗しました', 'error');
                    }
                } catch (error) {
                    showNotification('エラー', 'ログクリア中にエラーが発生しました', 'error');
                }
            }
        }
    );
}

// システム設定を読み込み
async function loadSystemSettings() {
    try {
        const response = await adminRequest('/admin/settings');
        if (response && response.ok) {
            const data = await response.json();
            const settings = data.data || data;
            
            document.getElementById('systemAdminUsername').value = settings.admin_username || 'admin';
            document.getElementById('systemSessionTimeout').value = settings.session_timeout || 24;
            document.getElementById('systemMaxUsers').value = settings.max_users || 1000;
            document.getElementById('systemDefaultModel').value = settings.default_model || 'gemini-2.5-flash-lite';
            document.getElementById('systemMaintenanceMode').checked = settings.maintenance_mode || false;
            document.getElementById('systemMaintenanceMessage').value = settings.maintenance_message || '';
            
            // API設定
            document.getElementById('apiGoogleKey').value = '';
            document.getElementById('apiClientId').value = settings.client_id || '';
            document.getElementById('apiRateLimit').value = settings.rate_limit || 60;
        }
    } catch (error) {
        console.error('設定読み込みエラー:', error);
    }
}

// システム設定を保存
async function saveSystemSettings() {
    const settings = {
        admin_username: document.getElementById('systemAdminUsername').value,
        session_timeout: parseInt(document.getElementById('systemSessionTimeout').value),
        max_users: parseInt(document.getElementById('systemMaxUsers').value),
        default_model: document.getElementById('systemDefaultModel').value,
        maintenance_mode: document.getElementById('systemMaintenanceMode').checked,
        maintenance_message: document.getElementById('systemMaintenanceMessage').value,
        rate_limit: parseInt(document.getElementById('apiRateLimit').value)
    };
    
    try {
        const response = await adminRequest('/admin/settings', {
            method: 'POST',
            body: JSON.stringify(settings)
        });
        
        if (response && response.ok) {
            showNotification('成功', 'システム設定を保存しました', 'success');
        } else {
            showNotification('エラー', '設定の保存に失敗しました', 'error');
        }
    } catch (error) {
        showNotification('エラー', '設定の保存中にエラーが発生しました', 'error');
    }
}

// API接続テスト
async function testApiConnection() {
    try {
        const response = await adminRequest('/admin/api-test');
        if (response && response.ok) {
            const data = await response.json();
            showNotification('成功', data.message || 'API接続テストが成功しました', 'success');
        } else {
            showNotification('エラー', 'API接続テストに失敗しました', 'error');
        }
    } catch (error) {
        showNotification('エラー', 'API接続テスト中にエラーが発生しました', 'error');
    }
}

// 管理者ログアウト
async function adminLogout() {
    try {
        await adminRequest('/admin/logout', {
            method: 'POST'
        });
    } catch (error) {
        console.error('ログアウトエラー:', error);
    }
    
    currentAdminUser = '';
    adminDashboard.style.display = 'none';
    adminLogin.style.display = 'flex';
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
}

// 新しいユーザー追加
async function addNewUser() {
    const name = document.getElementById('addUserName').value;
    const email = document.getElementById('addUserEmail').value;
    const password = document.getElementById('addUserPassword').value;
    const role = document.getElementById('addUserRole').value;
    
    if (!name || !email || !password) {
        showNotification('エラー', 'すべての項目を入力してください', 'error');
        return;
    }
    
    try {
        const response = await adminRequest('/admin/users/add', {
            method: 'POST',
            body: JSON.stringify({ name, email, password, role })
        });
        
        if (response && response.ok) {
            showNotification('成功', 'ユーザーを追加しました', 'success');
            closeModal('addUserModal');
            loadUsers();
        } else if (response) {
            const data = await response.json();
            showNotification('エラー', data.error || 'ユーザー追加に失敗しました', 'error');
        }
    } catch (error) {
        showNotification('エラー', 'ユーザー追加中にエラーが発生しました', 'error');
    }
}

// 新しいドメイン追加
async function addNewDomain() {
    const domain = document.getElementById('addDomainName').value;
    const description = document.getElementById('addDomainDescription').value;
    const type = document.getElementById('addDomainType').value;
    
    if (!domain) {
        showNotification('エラー', 'ドメイン名を入力してください', 'error');
        return;
    }
    
    try {
        const response = await adminRequest('/admin/domains/add', {
            method: 'POST',
            body: JSON.stringify({ domain, description, type })
        });
        
        if (response && response.ok) {
            showNotification('成功', 'ドメインを追加しました', 'success');
            closeModal('addDomainModal');
            loadDomains();
        } else if (response) {
            const data = await response.json();
            showNotification('エラー', data.error || 'ドメイン追加に失敗しました', 'error');
        }
    } catch (error) {
        showNotification('エラー', 'ドメイン追加中にエラーが発生しました', 'error');
    }
}

// ユーザー追加モーダル表示
function showAddUserModal() {
    document.getElementById('addUserName').value = '';
    document.getElementById('addUserEmail').value = '';
    document.getElementById('addUserPassword').value = '';
    document.getElementById('addUserRole').value = 'user';
    
    document.getElementById('addUserModal').style.display = 'flex';
}

// ドメイン追加モーダル表示
function showAddDomainModal() {
    document.getElementById('addDomainName').value = '';
    document.getElementById('addDomainDescription').value = '';
    document.getElementById('addDomainType').value = 'exact';
    
    document.getElementById('addDomainModal').style.display = 'flex';
}

// モーダル閉じる
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// 確認ダイアログ
function showConfirm(title, message, callback) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmModal').style.display = 'flex';
    confirmCallback = callback;
}

function confirmAction(result) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
    }
}

// 通知表示
function showNotification(title, message, type = 'info') {
    const container = document.getElementById('notificationContainer');
    const id = 'notification-' + Date.now();
    
    const notification = document.createElement('div');
    notification.id = id;
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-icon">
            ${type === 'success' ? '✓' : type === 'error' ? '✕' : type === 'warning' ? '⚠' : 'ℹ'}
        </div>
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="document.getElementById('${id}').remove()">
            ✕
        </button>
    `;
    
    container.appendChild(notification);
    
    // アニメーション
    setTimeout(() => notification.classList.add('show'), 10);
    
    // 自動削除
    const duration = type === 'error' ? 10000 : 5000;
    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }
    }, duration);
}

// セクション切り替え
function switchSection(section) {
    // ナビゲーションのアクティブ状態を更新
    document.querySelectorAll('.admin-nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-section') === section) {
            item.classList.add('active');
        }
    });
    
    // セクションを非表示
    document.querySelectorAll('.admin-section').forEach(sec => {
        sec.style.display = 'none';
    });
    
    // 選択したセクションを表示
    const sectionId = 'section' + capitalizeFirstLetter(section);
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
        sectionElement.style.display = 'block';
        adminPageTitle.textContent = getSectionTitle(section);
        
        // セクション固有のデータを読み込む
        switch (section) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'users':
                loadUsers();
                break;
            case 'domains':
                loadDomains();
                break;
            case 'history':
                loadHistory();
                break;
            case 'system':
                loadSystemSettings();
                break;
            case 'api':
                // APIセクションのデータを読み込む
                break;
            case 'logs':
                loadLogs();
                break;
        }
    }
}

// ヘルパー関数
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

function getSectionTitle(section) {
    const titles = {
        'dashboard': 'ダッシュボード',
        'users': 'ユーザー管理',
        'domains': 'ドメイン管理',
        'history': 'チャット履歴',
        'system': 'システム設定',
        'api': 'API管理',
        'logs': 'アクセスログ'
    };
    return titles[section] || section;
}

function formatDate(isoString) {
    if (!isoString || isoString === '未ログイン') return isoString;
    try {
        const date = new Date(isoString);
        return date.toLocaleDateString('ja-JP');
    } catch {
        return isoString;
    }
}

function formatDateTime(isoString) {
    if (!isoString) return '-';
    try {
        const date = new Date(isoString);
        return date.toLocaleString('ja-JP');
    } catch {
        return isoString;
    }
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'active': return 'badge-success';
        case 'suspended': return 'badge-warning';
        case 'banned': return 'badge-danger';
        default: return 'badge-info';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'active': return 'アクティブ';
        case 'suspended': return '一時停止';
        case 'banned': return '禁止';
        default: return status;
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 統計更新
function refreshStats() {
    loadDashboardData();
    showNotification('情報', '統計を更新しました', 'info');
}
  </script>
</body>
</html>