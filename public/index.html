<!DOCTYPE html>
<html lang="ja" dir="ltr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Copilot</title>

  <!-- Copilot å®ŸCSS -->
  <link rel="stylesheet" href="index-imRmuNkR.css" />
  <style>
    /* å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ä¿æŒ */
    .message-user {
      background-color: #1c2338;
      color: #f1f5f9;
      border-radius: 18px 4px 18px 18px;
      margin-left: auto;
      max-width: 85%;
      position: relative;
      overflow: hidden;
    }
    
    .message-user::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(29, 78, 216, 0.05) 100%);
      pointer-events: none;
    }
    
    .message-ai {
      background-color: transparent;
      color: #f1f5f9;
      border-radius: 4px 18px 18px 18px;
      margin-right: auto;
      max-width: 85%;
    }
    
    .message-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 16px 0;
    }
    
    .message-content {
      padding: 12px 16px;
      font-size: 14px;
      line-height: 1.6;
      position: relative;
      z-index: 1;
    }
    
    .message-ai .message-content {
      padding-left: 0;
    }
    
    .input-container {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 24px;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }
    
    .input-container:focus-within {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    
    .chip {
      background: #1e293b;
      border: 1px solid #334155;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #cbd5e1;
    }
    
    .chip:hover {
      background: #334155;
      color: #ffffff;
    }
    
    .nav-item {
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.2s ease;
      color: #cbd5e1;
    }
    
    .nav-item:hover {
      background: #1e293b;
      color: #ffffff;
    }
    
    .nav-item.active {
      background: #1e293b;
      color: #ffffff;
      font-weight: 500;
    }
    
    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-user, .message-ai {
      animation: fadeInUp 0.3s ease-out;
    }
    
    /* AIã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .ai-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .ai-message-wrapper {
      display: flex;
      align-items: flex-start;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 8px 16px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #94a3b8;
      margin: 0 2px;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
      40% { transform: translateY(-10px); opacity: 1; }
    }
    
    /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .error-message {
      background-color: rgba(239, 68, 68, 0.1);
      border-left: 3px solid #ef4444;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      color: #fecaca;
      font-size: 13px;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal-content {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: white;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }
    
    .modal-close:hover {
      background: #1e293b;
      color: white;
    }
    
    .modal-tabs {
      display: flex;
      border-bottom: 1px solid #334155;
    }
    
    .modal-tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      background: none;
      border: none;
      color: #94a3b8;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-tab.active {
      color: white;
      border-bottom: 2px solid #3b82f6;
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      color: #cbd5e1;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .btn-primary {
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-google {
      width: 100%;
      padding: 12px;
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }
    
    .btn-google:hover {
      background: #f9fafb;
    }
    
    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: #64748b;
    }
    
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #334155;
    }
    
    .divider-text {
      padding: 0 12px;
      font-size: 14px;
    }
    
    .user-menu {
      position: absolute;
      bottom: 70px;
      left: 20px;
      width: 250px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 50;
      overflow: hidden;
    }
    
    .user-profile {
      padding: 16px;
      border-bottom: 1px solid #334155;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
    }
    
    .user-info {
      margin-left: 12px;
    }
    
    .user-name {
      font-weight: 500;
      color: white;
      font-size: 14px;
    }
    
    .user-email {
      color: #94a3b8;
      font-size: 12px;
      margin-top: 2px;
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      color: #cbd5e1;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .menu-item:hover {
      background: #1e293b;
      color: white;
    }
    
    .menu-icon {
      margin-right: 12px;
      font-size: 16px;
    }
    
    /* ãƒ¢ãƒ‡ãƒ«è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .model-badge {
      background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
      color: white;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    /* ===== é«˜ç´šæ„Ÿã‚ã‚‹é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  ===== */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .notification {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateX(120%);
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 12px;
    }
    
    .notification-success .notification-icon {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }
    
    .notification-error .notification-icon {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
    
    .notification-warning .notification-icon {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }
    
    .notification-info .notification-icon {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }
    
    .notification-content {
      flex: 1;
      min-width: 0;
    }
    
    .notification-title {
      font-weight: 600;
      color: white;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .notification-message {
      color: #94a3b8;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .notification-close {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      margin-left: 8px;
      flex-shrink: 0;
    }
    
    .notification-close:hover {
      background: #1e293b;
      color: white;
    }
    
    /* ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
    .confirm-modal {
      max-width: 380px;
    }
    
    .confirm-modal .modal-body {
      padding-bottom: 20px;
    }
    
    .confirm-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 20px;
    }
    
    .confirm-modal.warning .confirm-icon {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }
    
    .confirm-modal.info .confirm-icon {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }
    
    .confirm-title {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: white;
      margin-bottom: 8px;
    }
    
    .confirm-message {
      text-align: center;
      color: #94a3b8;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    
    .confirm-actions {
      display: flex;
      gap: 12px;
    }
    
    .confirm-actions .btn-primary {
      flex: 1;
    }
    
    .confirm-actions .btn-secondary {
      flex: 1;
      padding: 12px;
      background: #1e293b;
      color: #cbd5e1;
      border: 1px solid #334155;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .confirm-actions .btn-secondary:hover {
      background: #334155;
      color: white;
    }
    
    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(100%);
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
    }
    
    .toast-success .toast-icon {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }
    
    .toast-message {
      color: #cbd5e1;
      font-size: 13px;
      flex: 1;
    }
    
    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .profile-modal {
      max-width: 450px;
    }
    
    .profile-info {
      background: #1e293b;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .profile-row {
      display: flex;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #334155;
    }
    
    .profile-row:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .profile-label {
      width: 120px;
      color: #94a3b8;
      font-size: 13px;
      flex-shrink: 0;
    }
    
    .profile-value {
      color: white;
      font-size: 13px;
      flex: 1;
    }
  </style>
</head>
<body data-tabster='{"root":{}}'>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="loginModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <button class="modal-close" onclick="hideLoginModal()">âœ•</button>
      </div>
      
      <div class="modal-tabs">
        <button id="loginTab" class="modal-tab active" onclick="showLoginTab()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="registerTab" class="modal-tab" onclick="showRegisterTab()">æ–°è¦ç™»éŒ²</button>
      </div>
      
      <div class="modal-body">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="loginForm">
          <div class="form-group">
            <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" id="loginEmail" class="form-input" placeholder="your@email.com">
            <small style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;">
              ä¿¡é ¼ã§ãã‚‹ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆGmail, Outlook, Yahooãªã©ï¼‰ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™
            </small>
          </div>
          <div class="form-group">
            <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="loginPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <button class="btn-primary" onclick="loginWithEmail()">ãƒ­ã‚°ã‚¤ãƒ³</button>
          
          <div class="divider">
            <span class="divider-text">ã¾ãŸã¯</span>
          </div>
          
          <button class="btn-google" onclick="loginWithGoogle()">
            <img src="https://www.google.com/favicon.ico" alt="Google" width="18" height="18">
            Googleã§ç¶šã‘ã‚‹
          </button>
        </div>
        
        <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="registerForm" style="display: none;">
          <div class="form-group">
            <label class="form-label">åå‰</label>
            <input type="text" id="registerName" class="form-input" placeholder="å±±ç”° å¤ªéƒ">
          </div>
          <div class="form-group">
            <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" id="registerEmail" class="form-input" placeholder="your@email.com">
            <small style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;">
              ä¿¡é ¼ã§ãã‚‹ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆGmail, Outlook, Yahooãªã©ï¼‰ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™
            </small>
          </div>
          <div class="form-group">
            <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="registerPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <small style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;">
              8æ–‡å­—ä»¥ä¸Šã€è‹±å­—ã¨æ•°å­—ã‚’å«ã‚ã¦ãã ã•ã„
            </small>
          </div>
          <div class="form-group">
            <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
            <input type="password" id="registerPasswordConfirm" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <button class="btn-primary" onclick="registerWithEmail()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="userMenu" class="user-menu" style="display: none;">
    <div class="user-profile" style="display: flex; align-items: center;">
      <div id="userAvatar" class="user-avatar">U</div>
      <div class="user-info">
        <div id="userName" class="user-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</div>
        <div id="userEmail" class="user-email">user@example.com</div>
      </div>
    </div>
    <div class="menu-item" onclick="viewProfile()">
      <span class="menu-icon">ğŸ‘¤</span>
      ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
    </div>
    <div class="menu-item" onclick="logout()" style="color: #f87171;">
      <span class="menu-icon">ğŸšª</span>
      ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    </div>
  </div>

  <!-- é€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="notification-container" id="notificationContainer"></div>
  
  <!-- ãƒˆãƒ¼ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="toast-container" id="toastContainer"></div>
  
  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="confirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content confirm-modal">
      <div class="modal-body">
        <div class="confirm-icon">âš ï¸</div>
        <div class="confirm-title" id="confirmTitle">ç¢ºèª</div>
        <div class="confirm-message" id="confirmMessage">ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
        <div class="confirm-actions">
          <button class="btn-secondary" onclick="hideConfirmModal(false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn-primary" onclick="hideConfirmModal(true)">ç¶šè¡Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="profileModal" class="modal-overlay" style="display: none;">
    <div class="modal-content profile-modal">
      <div class="modal-header">
        <h2 class="modal-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
        <button class="modal-close" onclick="hideProfileModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="profile-info">
          <div class="profile-row">
            <div class="profile-label">åå‰</div>
            <div class="profile-value" id="profileName">-</div>
          </div>
          <div class="profile-row">
            <div class="profile-label">ãƒ¡ãƒ¼ãƒ«</div>
            <div class="profile-value" id="profileEmail">-</div>
          </div>
          <div class="profile-row">
            <div class="profile-label">ãƒ‰ãƒ¡ã‚¤ãƒ³</div>
            <div class="profile-value" id="profileDomain">-</div>
          </div>
          <div class="profile-row">
            <div class="profile-label">ç™»éŒ²æ—¥</div>
            <div class="profile-value" id="profileCreatedAt">-</div>
          </div>
          <div class="profile-row">
            <div class="profile-label">èªè¨¼æ–¹æ³•</div>
            <div class="profile-value" id="profileProvider">-</div>
          </div>
          <div class="profile-row">
            <div class="profile-label">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</div>
            <div class="profile-value" id="profileLastLogin">-</div>
          </div>
        </div>
        <button class="btn-primary" onclick="hideProfileModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="app" class="flex h-full overflow-hidden bg-sidebar-dark">
    <!-- ===== Sidebar ===== -->
    <aside class="relative hidden md:flex md:w-[280px] flex-col bg-[#020617] border-r border-slate-800">
      <div class="flex items-center gap-2 px-4 py-3">
        <div class="w-5 h-5 rounded bg-gradient-to-br from-blue-500 to-purple-500"></div>
        <span class="text-sm font-semibold text-white">Copilot</span>
        <span class="model-badge">Gemini 2.5</span>
      </div>
      <nav class="flex-1 px-2 text-sm mt-4">
        <div class="nav-item active" onclick="newChat()">
          <span class="mr-2">ğŸ’¬</span> æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ
        </div>
        <div class="nav-item">
          <span class="mr-2">ğŸ”</span> ç™ºè¦‹ã™ã‚‹
        </div>
        <div class="nav-item">
          <span class="mr-2">ğŸ¨</span> Imagine 
          <span class="ml-auto text-xs bg-slate-700 text-slate-300 rounded px-2 py-0.5">æ–°è¦</span>
        </div>
        <div class="nav-item">
          <span class="mr-2">ğŸ“š</span> ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
        </div>
        <div class="nav-item">
          <span class="mr-2">ğŸ§ª</span> Labs
        </div>
        <div class="mt-8 px-2 text-xs text-slate-400 font-medium">æœ€è¿‘ã®ä¼šè©±</div>
        <div id="historyList" class="mt-2 px-2 text-xs text-slate-500">
          ä¼šè©±å±¥æ­´ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      </nav>
      <div id="sidebarBottom" class="border-t border-slate-800 p-3">
        <!-- åˆæœŸçŠ¶æ…‹ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
        <button onclick="showLoginModal()" class="w-full flex items-center justify-center gap-2 text-sm text-slate-300 hover:text-white rounded-lg bg-slate-800/50 px-3 py-2 hover:bg-slate-800 transition-colors">
          <span>ğŸ”</span> ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </div>
    </aside>

    <!-- ===== Main ===== -->
    <main class="flex flex-1 flex-col bg-gradient-to-b from-[#0b1220] to-[#020617] relative">
      <!-- Welcome Screen -->
      <div id="welcome" class="flex flex-1 flex-col items-center justify-center text-slate-300 gap-8">
        <div class="text-2xl font-medium text-white">ä»Šæ—¥ã¯ã©ã‚“ãªã“ã¨ã‚’è€ƒãˆã¦ã„ã¾ã™ã‹?</div>
        
        <!-- ãƒ¢ãƒ‡ãƒ«æƒ…å ±è¡¨ç¤º -->
        <div class="flex items-center gap-2 text-sm text-slate-400">
          <span class="model-badge">Gemini 2.5 Flash Lite</span>
          <span class="text-xs">é«˜é€Ÿã§åŠ¹ç‡çš„ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</span>
        </div>

        <!-- Composer (center) -->
        <div class="w-full max-w-2xl px-4">
          <div class="input-container flex items-center gap-2 px-5 py-4">
            <button class="text-slate-400 hover:text-white p-1.5 rounded-lg hover:bg-slate-800/50">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </button>
            <input
              id="prompt"
              placeholder="Copilot ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹"
              class="flex-1 bg-transparent outline-none text-sm text-white placeholder-slate-500 px-2"
              autocomplete="off"
            />
            <button onclick="sendPrompt()" class="text-slate-300 hover:text-white p-1.5 rounded-lg hover:bg-slate-800/50">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            </button>
          </div>

          <!-- Suggestions -->
          <div class="mt-8 flex flex-wrap gap-3 justify-center">
            <span class="chip" onclick="fillPrompt('æ›²ã‚’ä½œã‚‹')">æ›²ã‚’ä½œã‚‹</span>
            <span class="chip" onclick="fillPrompt('ç”»åƒã‚’ä½œæˆã™ã‚‹')">ç”»åƒã‚’ä½œæˆã™ã‚‹</span>
            <span class="chip" onclick="fillPrompt('ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘ã‚‹')">ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘ã‚‹</span>
            <span class="chip" onclick="fillPrompt('æ–‡ç« ã‚’æ”¹å–„ã™ã‚‹')">æ–‡ç« ã‚’æ”¹å–„ã™ã‚‹</span>
            <span class="chip" onclick="fillPrompt('æœªæ¥ã‚’äºˆæ¸¬ã™ã‚‹')">æœªæ¥ã‚’äºˆæ¸¬ã™ã‚‹</span>
            <span class="chip" onclick="fillPrompt('è€ƒãˆã‚’æ•´ç†ã™ã‚‹')">è€ƒãˆã‚’æ•´ç†ã™ã‚‹</span>
            <span class="chip" onclick="fillPrompt('ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã‚‹')">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã‚‹</span>
            <span class="chip" onclick="fillPrompt('æœ€åˆã®ä¸‹æ›¸ãã‚’ä½œæˆã™ã‚‹')">æœ€åˆã®ä¸‹è‰æ¡ˆã‚’ä½œæˆã™ã‚‹</span>
          </div>
        </div>
        
        <!-- Footer note -->
        <div class="absolute bottom-6 text-xs text-slate-500 text-center">
          Copilotã¯Gemini 2.5 Flash Liteãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ç”Ÿæˆã•ã‚Œã‚‹å†…å®¹ã¯æ­£ç¢ºã§ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
        </div>
      </div>

      <!-- Chat Container -->
      <div id="chat" class="hidden flex-1 overflow-y-auto">
        <div class="max-w-3xl mx-auto px-4 py-8 message-container" id="messageContainer">
          <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
      </div>
      
      <!-- Chat Input -->
      <div id="chatInput" class="hidden p-6 border-t border-slate-800/50 bg-gradient-to-t from-[#0b1220] via-[#0b1220] to-transparent">
        <div class="max-w-3xl mx-auto">
          <div class="flex items-center justify-between mb-3">
            <div class="text-xs text-slate-400">
              ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«: <span class="model-badge">Gemini 2.5 Flash Lite</span>
            </div>
            <div class="text-xs text-slate-500">
              ç„¡æ–™ãƒ—ãƒ©ãƒ³ã¯ç”Ÿæˆå›æ•°ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™
            </div>
          </div>
          <div class="input-container flex items-center gap-2 px-5 py-4">
            <button class="text-slate-400 hover:text-white p-1.5 rounded-lg hover:bg-slate-800/50" onclick="attachFile()">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
              </svg>
            </button>
            <input
              id="chatPrompt"
              placeholder="Copilot ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹"
              class="flex-1 bg-transparent outline-none text-sm text-white placeholder-slate-500 px-2"
              autocomplete="off"
            />
            <button onclick="sendChatPrompt()" class="text-slate-300 hover:text-white p-1.5 rounded-lg hover:bg-slate-800/50">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ===== JavaScript ===== -->
  <script>
// DOMè¦ç´ 
const chatDiv = document.getElementById('chat');
const welcomeDiv = document.getElementById('welcome');
const promptInput = document.getElementById('prompt');
const chatPromptInput = document.getElementById('chatPrompt');
const chatInputDiv = document.getElementById('chatInput');
const messageContainer = document.getElementById('messageContainer');
const historyList = document.getElementById('historyList');
const sidebarBottom = document.getElementById('sidebarBottom');
const loginModal = document.getElementById('loginModal');
const userMenu = document.getElementById('userMenu');
const confirmModal = document.getElementById('confirmModal');
const profileModal = document.getElementById('profileModal');

// çŠ¶æ…‹ç®¡ç†
let history = [];
let currentEmail = '';
let isTyping = false;
let isAuthenticated = false;
let currentUser = {
  email: '',
  name: '',
  logged_in: false
};
let confirmCallback = null;

// é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
class NotificationSystem {
  constructor() {
    this.notificationContainer = document.getElementById('notificationContainer');
    this.toastContainer = document.getElementById('toastContainer');
    this.notificationId = 0;
  }
  
  showNotification(type, title, message, duration = 5000) {
    const id = `notification-${++this.notificationId}`;
    const iconMap = {
      success: 'âœ“',
      error: 'âœ•',
      warning: 'âš ',
      info: 'â„¹'
    };
    
    const notification = document.createElement('div');
    notification.id = id;
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <div class="notification-icon">${iconMap[type]}</div>
      <div class="notification-content">
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      </div>
      <button class="notification-close" onclick="this.closest('.notification').remove()">âœ•</button>
    `;
    
    this.notificationContainer.appendChild(notification);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    setTimeout(() => notification.classList.add('show'), 10);
    
    // è‡ªå‹•å‰Šé™¤
    if (duration > 0) {
      setTimeout(() => {
        if (notification.parentNode) {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }
      }, duration);
    }
    
    return id;
  }
  
  showToast(type, message, duration = 3000) {
    const id = `toast-${++this.notificationId}`;
    const iconMap = {
      success: 'âœ“',
      error: 'âœ•',
      warning: 'âš ',
      info: 'â„¹'
    };
    
    const toast = document.createElement('div');
    toast.id = id;
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-icon">${iconMap[type]}</div>
      <div class="toast-message">${message}</div>
    `;
    
    this.toastContainer.appendChild(toast);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    setTimeout(() => toast.classList.add('show'), 10);
    
    // è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }
    }, duration);
    
    return id;
  }
  
  removeNotification(id) {
    const element = document.getElementById(id);
    if (element) {
      element.classList.remove('show');
      setTimeout(() => element.remove(), 300);
    }
  }
}

const notify = new NotificationSystem();

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
  checkAuthStatus();
  
  // Enterã‚­ãƒ¼ã§é€ä¿¡
  promptInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendPrompt();
    }
  });
  
  chatPromptInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChatPrompt();
    }
  });
  
  // ã‚µã‚¸ã‚§ã‚¹ãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
  loadHistoryList();
});

// ===== é€šçŸ¥ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° =====
function showSuccess(message, title = 'æˆåŠŸ') {
  return notify.showNotification('success', title, message);
}

function showError(message, title = 'ã‚¨ãƒ©ãƒ¼') {
  return notify.showNotification('error', title, message);
}

function showInfo(message, title = 'æƒ…å ±') {
  return notify.showNotification('info', title, message);
}

function showWarning(message, title = 'è­¦å‘Š') {
  return notify.showNotification('warning', title, message);
}

function showToastSuccess(message) {
  return notify.showToast('success', message);
}

function showToastError(message) {
  return notify.showToast('error', message);
}

function showConfirm(title, message, callback) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMessage').textContent = message;
  confirmModal.style.display = 'flex';
  confirmCallback = callback;
}

function hideConfirmModal(result) {
  confirmModal.style.display = 'none';
  if (confirmCallback) {
    confirmCallback(result);
    confirmCallback = null;
  }
}

function showProfileModal(profile) {
  document.getElementById('profileName').textContent = profile.name || '-';
  document.getElementById('profileEmail').textContent = profile.email || '-';
  document.getElementById('profileDomain').textContent = profile.domain || '-';
  document.getElementById('profileCreatedAt').textContent = profile.created_at ? 
    new Date(profile.created_at).toLocaleDateString('ja-JP') : '-';
  document.getElementById('profileProvider').textContent = 
    profile.provider === 'google' ? 'Google' : 'ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰';
  document.getElementById('profileLastLogin').textContent = profile.last_login ? 
    new Date(profile.last_login).toLocaleString('ja-JP') : 'æœªè¨˜éŒ²';
  profileModal.style.display = 'flex';
}

function hideProfileModal() {
  profileModal.style.display = 'none';
}

// ===== èªè¨¼é–¢æ•° =====

// èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
async function checkAuthStatus() {
  try {
    const res = await fetch('/auth/status', {
      credentials: 'include'
    });
    const data = await res.json();
    
    if (data.logged_in) {
      isAuthenticated = true;
      currentUser = data.user || {
        email: data.email || '',
        name: data.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
        logged_in: true
      };
      currentEmail = currentUser.email;
      updateUIForLoggedInUser();
      showToastSuccess(`${currentUser.name}ã•ã‚“ã€ã‚ˆã†ã“ãï¼`);
    } else {
      showLoginModal();
    }
  } catch (err) {
    console.error('èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', err);
    showLoginModal();
  }
}

// ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
function showLoginModal() {
  loginModal.style.display = 'flex';
}

// ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
function hideLoginModal() {
  loginModal.style.display = 'none';
}

// ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ–è¡¨ç¤º
function showLoginTab() {
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('registerForm').style.display = 'none';
  document.getElementById('loginTab').classList.add('active');
  document.getElementById('registerTab').classList.remove('active');
}

// ç™»éŒ²ã‚¿ãƒ–è¡¨ç¤º
function showRegisterTab() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('registerForm').style.display = 'block';
  document.getElementById('registerTab').classList.add('active');
  document.getElementById('loginTab').classList.remove('active');
}

// ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³
async function loginWithEmail() {
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    showError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  try {
    const res = await fetch('/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email, password })
    });
    
    const data = await res.json();
    
    if (res.ok && data.status === 'success') {
      isAuthenticated = true;
      currentUser = {
        email: data.data?.email || email,
        name: data.data?.name || email.split('@')[0],
        logged_in: true,
        provider: 'email'
      };
      currentEmail = currentUser.email;
      hideLoginModal();
      updateUIForLoggedInUser();
      showSuccess('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼');
      
      // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    } else {
      throw new Error(data.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  } catch (err) {
    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
    showError('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}

// ãƒ¡ãƒ¼ãƒ«ã§ç™»éŒ²
async function registerWithEmail() {
  const name = document.getElementById('registerName').value.trim();
  const email = document.getElementById('registerEmail').value.trim().toLowerCase();
  const password = document.getElementById('registerPassword').value;
  const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
  
  if (!email || !password) {
    showError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  if (password !== passwordConfirm) {
    showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
    return;
  }
  
  try {
    const res = await fetch('/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email, password, name })
    });
    
    const data = await res.json();
    
    if (res.ok && data.status === 'success') {
      isAuthenticated = true;
      currentUser = {
        email: data.data?.email || email,
        name: data.data?.name || name,
        logged_in: true,
        provider: 'email'
      };
      currentEmail = currentUser.email;
      hideLoginModal();
      updateUIForLoggedInUser();
      showSuccess('ç™»éŒ²å®Œäº†ï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚');
      
      // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('registerName').value = '';
      document.getElementById('registerEmail').value = '';
      document.getElementById('registerPassword').value = '';
      document.getElementById('registerPasswordConfirm').value = '';
    } else {
      throw new Error(data.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  } catch (err) {
    console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', err);
    showError('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}

// Googleãƒ­ã‚°ã‚¤ãƒ³
function loginWithGoogle() {
  showInfo('Googleãƒ­ã‚°ã‚¤ãƒ³ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
}

// ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®UIæ›´æ–°
function updateUIForLoggedInUser() {
  // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ›´æ–°
  sidebarBottom.innerHTML = `
    <div class="flex items-center gap-3 cursor-pointer" onclick="toggleUserMenu()">
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-medium text-sm">
        ${currentUser.name?.charAt(0).toUpperCase() || 'U'}
      </div>
      <div class="flex-1 min-w-0">
        <div class="text-sm font-medium text-white truncate">${currentUser.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</div>
        <div class="text-xs text-slate-400 truncate">${currentUser.email}</div>
      </div>
      <span class="text-slate-400">â–¼</span>
    </div>
    <div class="mt-3 flex gap-2">
      <button onclick="loadHistory()" class="flex-1 flex items-center justify-center gap-1 text-sm text-slate-300 hover:text-white rounded-lg bg-slate-800/50 px-3 py-2 hover:bg-slate-800 transition-colors">
        <span>ğŸ“œ</span> å±¥æ­´èª­è¾¼
      </button>
      <button onclick="saveHistory()" class="flex-1 flex items-center justify-center gap-1 text-sm text-slate-300 hover:text-white rounded-lg bg-slate-800/50 px-3 py-2 hover:bg-slate-800 transition-colors">
        <span>ğŸ’¾</span> å±¥æ­´ä¿å­˜
      </button>
    </div>
  `;
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’è¨­å®š
  document.getElementById('userName').textContent = currentUser.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
  document.getElementById('userEmail').textContent = currentUser.email || '';
  document.getElementById('userAvatar').textContent = (currentUser.name?.charAt(0) || 'U').toUpperCase();
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
  localStorage.setItem('copilot_email', currentUser.email);
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
function toggleUserMenu() {
  if (userMenu.style.display === 'none' || userMenu.style.display === '') {
    userMenu.style.display = 'block';
    
    // ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    setTimeout(() => {
      const closeMenu = (e) => {
        if (!userMenu.contains(e.target) && !sidebarBottom.contains(e.target)) {
          userMenu.style.display = 'none';
          document.removeEventListener('click', closeMenu);
        }
      };
      document.addEventListener('click', closeMenu);
    }, 10);
  } else {
    userMenu.style.display = 'none';
  }
}

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
async function viewProfile() {
  try {
    const res = await fetch('/user/profile', {
      credentials: 'include'
    });
    
    if (res.ok) {
      const data = await res.json();
      const profile = data.data || data;
      showProfileModal(profile);
      userMenu.style.display = 'none';
    } else {
      const data = await res.json();
      throw new Error(data.error || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  } catch (err) {
    console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    showError('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
async function logout() {
  showConfirm(
    'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
    'æœ¬å½“ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
    async (confirmed) => {
      if (!confirmed) return;
      
      try {
        const res = await fetch('/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          isAuthenticated = false;
          currentUser = {
            email: '',
            name: '',
            logged_in: false
          };
          currentEmail = '';
          
          // UIã‚’ãƒªã‚»ãƒƒãƒˆ
          sidebarBottom.innerHTML = `
            <button onclick="showLoginModal()" class="w-full flex items-center justify-center gap-2 text-sm text-slate-300 hover:text-white rounded-lg bg-slate-800/50 px-3 py-2 hover:bg-slate-800 transition-colors">
              <span>ğŸ”</span> ãƒ­ã‚°ã‚¤ãƒ³
            </button>
          `;
          
          userMenu.style.display = 'none';
          localStorage.removeItem('copilot_email');
          
          showSuccess('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
          showLoginModal();
        } else {
          throw new Error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (err) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', err);
        showError('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ' + err.message);
      }
    }
  );
}

// ===== æ—¢å­˜é–¢æ•°ï¼ˆèªè¨¼ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰ =====

// ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚»ãƒƒãƒˆ
function fillPrompt(text) {
  if (!isAuthenticated) {
    showLoginModal();
    return;
  }
  
  if (welcomeDiv.classList.contains('hidden')) {
    chatPromptInput.value = text;
    chatPromptInput.focus();
    showToastSuccess(`ã€Œ${text}ã€ã‚’å…¥åŠ›ã—ã¾ã—ãŸ`);
  } else {
    promptInput.value = text;
    promptInput.focus();
    showToastSuccess(`ã€Œ${text}ã€ã‚’å…¥åŠ›ã—ã¾ã—ãŸ`);
  }
}

// æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ
function newChat() {
  if (!isAuthenticated) {
    showLoginModal();
    return;
  }
  
  if (history.length > 0) {
    showConfirm(
      'æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ',
      'ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã‚’çµ‚äº†ã—ã¦æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ',
      (confirmed) => {
        if (confirmed) {
          history = [];
          welcomeDiv.classList.remove('hidden');
          chatDiv.classList.add('hidden');
          chatInputDiv.classList.add('hidden');
          promptInput.value = '';
          promptInput.focus();
          showToastSuccess('æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸ');
        }
      }
    );
  } else {
    history = [];
    welcomeDiv.classList.remove('hidden');
    chatDiv.classList.add('hidden');
    chatInputDiv.classList.add('hidden');
    promptInput.value = '';
    promptInput.focus();
    showToastSuccess('æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸ');
  }
}

// å±¥æ­´ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
async function loadHistoryList() {
  try {
    const res = await fetch('/health');
    const data = await res.json();
    
    if (data.api_key_set) {
      historyList.innerHTML = '<div class="text-green-400">âœ“ APIæ¥ç¶šæ¸ˆã¿</div>';
    } else {
      historyList.innerHTML = '<div class="text-red-400">âœ— APIã‚­ãƒ¼æœªè¨­å®š</div>';
    }
  } catch (err) {
    historyList.innerHTML = '<div class="text-red-400">âœ— ã‚µãƒ¼ãƒãƒ¼æœªæ¥ç¶š</div>';
  }
}

// å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
async function loadHistory() {
  if (!isAuthenticated) {
    showLoginModal();
    return;
  }
  
  try {
    const res = await fetch(`/history?email=${encodeURIComponent(currentEmail)}`, {
      credentials: 'include'
    });
    
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || 'å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    const loadedHistory = await res.json();
    history = loadedHistory;
    
    if (history.length > 0) {
      // ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‚’éè¡¨ç¤ºã€ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’è¡¨ç¤º
      welcomeDiv.classList.add('hidden');
      chatDiv.classList.remove('hidden');
      chatInputDiv.classList.remove('hidden');
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      renderMessages();
      showSuccess(`${history.length}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    } else {
      showInfo('å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚');
      startNewChat();
    }
  } catch (err) {
    console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
    showError('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}

// å±¥æ­´ã‚’ä¿å­˜
async function saveHistory() {
  if (!isAuthenticated) {
    showLoginModal();
    return;
  }
  
  if (history.length === 0) {
    showWarning('ä¿å­˜ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  try {
    const res = await fetch('/history', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ 
        email: currentEmail, 
        history: history 
      })
    });
    
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || 'å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    showSuccess('å±¥æ­´ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  } catch (err) {
    console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
    showError('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}

// æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹
function startNewChat() {
  welcomeDiv.classList.add('hidden');
  chatDiv.classList.remove('hidden');
  chatInputDiv.classList.remove('hidden');
  renderMessages();
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‹ã‚‰ï¼‰
async function sendPrompt() {
  if (!isAuthenticated) {
    showLoginModal();
    return;
  }
  
  const text = promptInput.value.trim();
  if (!text) {
    showError('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
  if (!welcomeDiv.classList.contains('hidden')) {
    startNewChat();
  }
  
  await addMessage('user', text);
  promptInput.value = '';
  
  // AIå¿œç­”ã‚’å–å¾—
  await getAIResponse(text);
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆãƒãƒ£ãƒƒãƒˆç”»é¢ã‹ã‚‰ï¼‰
async function sendChatPrompt() {
  if (!isAuthenticated) {
    showLoginModal();
    return;
  }
  
  const text = chatPromptInput.value.trim();
  if (!text) {
    showError('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  await addMessage('user', text);
  chatPromptInput.value = '';
  
  // AIå¿œç­”ã‚’å–å¾—
  await getAIResponse(text);
}

// AIå¿œç­”ã‚’å–å¾—
async function getAIResponse(userMessage) {
  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
  showTypingIndicator();
  
  try {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’ä½œæˆï¼ˆOpenAIå½¢å¼ï¼‰
    const messages = history.map(msg => ({
      role: msg.role === 'ai' ? 'assistant' : 'user',
      content: msg.text
    }));
    
    // æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    messages.push({ role: 'user', content: userMessage });
    
    // å›ºå®šãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ã‚‚å›ºå®šã•ã‚Œã¦ã„ã‚‹ãŒã€æ˜ç¤ºçš„ã«é€ä¿¡ï¼‰
    const res = await fetch('/proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        messages: messages,
        model: 'gemini-2.5-flash-lite'  // å›ºå®šãƒ¢ãƒ‡ãƒ«
      })
    });
    
    const data = await res.json();
    
    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
    hideTypingIndicator();
    
    if (res.ok && data.choices && data.choices[0]) {
      const aiResponse = data.choices[0].message.content;
      await addMessage('ai', aiResponse);
      
      // å±¥æ­´ã‚’è‡ªå‹•ä¿å­˜
      await saveHistory();
    } else {
      throw new Error(data.error || 'APIã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
    }
  } catch (err) {
    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
    hideTypingIndicator();
    
    console.error('AIå¿œç­”ã‚¨ãƒ©ãƒ¼:', err);
    await addMessage('error', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
    showError('AIå¿œç­”ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  }
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
function showTypingIndicator() {
  if (isTyping) return;
  
  isTyping = true;
  
  const wrapperDiv = document.createElement('div');
  wrapperDiv.className = 'ai-message-wrapper';
  wrapperDiv.id = 'typingIndicator';
  
  const iconDiv = document.createElement('div');
  iconDiv.className = 'ai-icon';
  iconDiv.textContent = 'AI';
  
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message-ai';
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'typing-indicator';
  contentDiv.innerHTML = `
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
  `;
  
  messageDiv.appendChild(contentDiv);
  wrapperDiv.appendChild(iconDiv);
  wrapperDiv.appendChild(messageDiv);
  messageContainer.appendChild(wrapperDiv);
  
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
function hideTypingIndicator() {
  isTyping = false;
  const indicator = document.getElementById('typingIndicator');
  if (indicator) {
    indicator.remove();
  }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
async function addMessage(role, text) {
  history.push({ role, text });
  renderMessages();
  
  // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }, 100);
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
function renderMessages() {
  messageContainer.innerHTML = '';
  
  history.forEach(msg => {
    if (msg.role === 'error') {
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const wrapperDiv = document.createElement('div');
      wrapperDiv.className = 'ai-message-wrapper';
      
      const iconDiv = document.createElement('div');
      iconDiv.className = 'ai-icon';
      iconDiv.textContent = 'âš ï¸';
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'error-message';
      messageDiv.innerHTML = msg.text.replace(/\n/g, '<br>');
      
      wrapperDiv.appendChild(iconDiv);
      wrapperDiv.appendChild(messageDiv);
      messageContainer.appendChild(wrapperDiv);
    } else if (msg.role === 'user') {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-user';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = msg.text.replace(/\n/g, '<br>');
      
      messageDiv.appendChild(contentDiv);
      messageContainer.appendChild(messageDiv);
    } else {
      // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const wrapperDiv = document.createElement('div');
      wrapperDiv.className = 'ai-message-wrapper';
      
      const iconDiv = document.createElement('div');
      iconDiv.className = 'ai-icon';
      iconDiv.textContent = 'AI';
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-ai';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = msg.text.replace(/\n/g, '<br>');
      
      messageDiv.appendChild(contentDiv);
      wrapperDiv.appendChild(iconDiv);
      wrapperDiv.appendChild(messageDiv);
      messageContainer.appendChild(wrapperDiv);
    }
  });
}

// ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ï¼ˆãƒ€ãƒŸãƒ¼æ©Ÿèƒ½ï¼‰
function attachFile() {
  if (!isAuthenticated) {
    showLoginModal();
    return;
  }
  showInfo('ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™');
}
  </script>
</body>
</html>